\section{Description and Methodology}

\subsection{Linux build process}

\subsection{The driver}

\subsection{The game}

The game implemented is Pong. Focus during development was kept on keeping code
clean and maintainable, using correct game programming patterns whenever
possible, while still keeping focus on energy efficiency.

As pong is a 'realtime' game, the amount of time one can spend asleep is
reduced compared to a game like chess, where the game can be entirely gamepad
interrupt driven.  To conserve power, the game enters sleep mode as often as
possible, and heavy calculations such as collision detection are avoided
whenever possible.

Additional care was taken to redraw as few pixels as possible during screen
updates.

\subsubsection{Structure of the game}

Following established patterns of game programming, updates of the games
internal state are fully decoupled from the rendering thereof.

At the start of each iteration of the game loop, lag (how much time we haven't
accounted for) is calculated, and caught up with.  This allows the game to
simulate at a fixed rate even on slower hardware, reducing only visual
performance.

If the game loop finishes ahead of time (using less than MS\_PER\_UPDATE ms),
sleep mode is entered for the remainder (time\_to\_next\_update).

With an internal update frequency target of 24 fps, ENTER EXAMPLE WITH
MICROCONTROLLER DATA HERE.  This allows the program to spend most of its time
sleeping.

\begin{algorithm}
  \caption{Game main loop}
  \begin{algorithmic}
    \State $lag \gets 0$
    \State $time\_previous \gets \Call{get\_time}{\null}$

    \Loop
      \State $time\_current \gets \Call{get\_time}{\null}$
      \State $time\_elapsed \gets time\_current - time\_previous$
      \State $lag \gets lag + time\_elapsed$

      \While{$lag \geq MS\_PER\_UPDATE$}
        \State $\Call{update}{\null}$
        \State $lag \gets lag - MS\_PER\_UPDATE$
      \EndWhile
      \State $\Call{draw\_game}{\null}$
      \State $\Call{sleep}{MS\_PER\_UPDATE - lag}$
    \EndLoop
  \end{algorithmic}
\end{algorithm}

\subsubsection{Input handling}
Whenever the gamepad changes state, i.e. a button is released or pressed,
a signal is received which in turn invokes an input interrupt handler.

The handler polls the gamepad driver, receiving a byte representing currently
pressed buttons. Input is then parsed to fit the games internal representation
of active keys. This abstraction layer between input and internal state is used
to allow for multiple methods of input, practical during development when a
computer keyboard is used.

Having an allways up to date version of button state cached frees the program
from having to poll the driver for each iteration of the main game loop.

\subsubsection{Graphics}
To display graphics on the screen, the game uses the Linux framebuffer device.
All the functions for initialising and adding graphics to the framebuffer are
contained in graphics.s.

The initializing function opens the framebuffer file in Linux, and then maps the
file to a region in memory.  This is done as it is easier to access an array
than to search back and forth in the file.  However, when this is done, the
framebuffer will not update after each write. As something is written to the
framebuffer, the area edited will be refreshed.

To actually make graphics, the draw\_pixel() function will color a given pixel
with a given color.  It can be called on a subsequent sequense of pixels to
create a more complex graphic.  For instance, draw\_rectangle() can with the
draw\_pixel() function create any rectangle on the screen.  As all the graphics
in the pong implementation in this project are square, to get that real nice
retro look, only a rectangle function was made.  There would, however, not be
any problem to create other shapes with this implementation.

The graphics code is generic when it comes to color, but again as the retro
feel was wanted, only black and green is defined in the program.  It is in the
specific sprite drawing functions that the color is set.

\subsubsection{Energy efficiency optimization}
