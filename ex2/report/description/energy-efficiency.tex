\subsection{Energy efficiency}

To save energy, the following techniques and features are used.

\subsubsection{Low energy modes}

\begin{figure}[H]
\centering
\includegraphics[width=0.75\textwidth]{figures/energymodes.png}
\caption{The energy modes of the Giant Gecko Microcontroller}
\label{fig:energymodes}
\end{figure}

The Giant Gecko micro controller has four different energy modes, with different peripherals available in each mode. As seen in figure \ref{fig:energymodes}, DMA is still available in EM 2, and the DAC is reachable in as low as EM3.

Whenever possible, the micro controller should enter a sleep mode to conserve energy.
In this implementation, the micro controller enters energy mode 2 when none of the timers are running, and energy mode 1 when playing a song or checking the buttons.

The only time the program needs to enter energy mode 0, is when the state machine needs updating.
This consumes a lot of power, but is a considered choice.
In a very simple application such as this, where all events that require an FSM update are generated by a single timer, the FSM can be updated from this interrupt service routine.
However in a more realistic application, events would be generated by several different sources, and updating the FSM in all of these different places is not desirable.

\subsubsection{Turning off unused GPIO}
Having GPIO lines enabled can cause so-called GPIO leakage, which might lead to extra power usage.
To prevent this, all unused GPIO ports are turned off.

\subsubsection{Disabling timers whenever possible}
Any timer will use more power while it is active, so it is not good practice to leave them on.
To save power, the button debounce timer is enabled in response to a GPIO interrupt, and the song timer is enabled in response to a play event. 

\subsubsection{Using DAC in sample and hold mode}
The DAC is configured in Sample/Hold Mode, which means that the DAC core is turned off between sample conversions.
The DAC core converts data on triggered conversion and holds the the output in a sample/hold element.
This element will only be held for a certain period of time because of output voltage drift.
The sampling period is set to the length of one prescaled clock cycle.

\subsubsection{Further work}
A few additional energy saving measures could have been implemented.
As the implementation of those turned out to be rather complex, DMA in particular, they are instead mentioned below for completeness.

\begin{description}
  \item[Use low energy timer (LETIMER) for checking buttons and playing music] \hfill \\
        In the current implementation, a normal timer is used for input detection. This is not necessary, as a low energy timer would be sufficient. The same holds for the timer used for music playback.
  \item[Use DMA to push samples to the DAC] \hfill \\ \label{DMA} 
      With Direct Memory Access, it would be possible to stay in low energy mode (EM1) when loading music to the DAC. This would result in a power drain in the low $ 100 \mu Ah $ per second during music playback, compared to the current power drain of $ 2 mAh $ in EM0.
\end{description}



